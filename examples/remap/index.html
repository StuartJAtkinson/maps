<!DOCTYPE html>
<html lang="en">
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">  

  <title>Leaflet - Remap</title>
  <link rel="shortcut icon" type="image/x-icon" href="data:," />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.toolbar.js/0.1.0/Leaflet.Toolbar.min.css" integrity="sha512-GA6tz0ONkXAXGUnZU9M7mMkiOiXuXis56gRc73qvS+hXP0Sgb/mXihcqs6haKhes6mMeCPIdopIDixMwnnd+Iw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.toolbar.js/0.1.0/Leaflet.Toolbar.min.js" integrity="sha512-5jHQLJ93JywT7NbjOuyHQzqLsTNYc7mjj0U5bBmsnrE1P9+4qqjKak0H+8jSlTzeNcbtDiTbV68pMQNTXbSTHQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-distortableimage@0.21.9/dist/leaflet.distortableimage.min.css">
  <script src="https://cdn.jsdelivr.net/npm/leaflet-distortableimage@0.21.9/dist/vendor.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet-distortableimage@0.21.9/dist/leaflet.distortableimage.min.js"></script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-mouse-position@1.2.0/src/L.Control.MousePosition.min.css">
  <script src="https://cdn.jsdelivr.net/npm/leaflet-mouse-position@1.2.0/src/L.Control.MousePosition.min.js"></script>

  <!--
  <link rel="stylesheet" href="leaflet.css" />
  <script src="leaflet.js"></script>
  <link rel="stylesheet" href="leaflet.toolbar.min.css"/>
  <script src="leaflet.toolbar.min.js"></script>
  <link rel="stylesheet" href="leaflet.distortableimage.css"/>
  <script src="vendor.js"></script>
  <script src="leaflet.distortableimage.js"></script>
  <script src="L.Control.MousePosition.js"></script>
  -->

  <style>
    html, body {
      height: 100%;
      width: 100%;
      margin: 0;
    }
    #map {
      height: 100%;
      width:  100%;
    }
  </style>
</head>
<body>

<div id="map" ></div>
<script>

  let localDataName = 'joricsRemap';
  let localData = JSON.parse(localStorage.getItem(localDataName)) || {"corners":[{"lat":51.567501756256505,"lng":-0.1764177405505252},{"lat":51.567501756256505,"lng":0.06345199242442146},{"lat":51.41815601816625,"lng":-0.1764177405505252},{"lat":51.41815601816625,"lng":0.06345199242442146}]}

  let imageURL = 'https://joric.github.io/maps/examples/data/LondonWorld.jpg';
  let markersURL = 'https://joric.github.io/maps/examples/data/geojson.markers.folon.json';

  let markers = null;

  let settings = localData;
  let london = [51.505, -0.09];

  let pos = london;
  let zoom = 12;

  let handles = [];

  const map = L.map('map', {
    zoomSnap: .1,
    wheelDebounceTime: 100,
  }).setView(pos, zoom);

  //let imgGroup = L.distortableCollection().addTo(map); // doesn't hide the image
  let imgGroup = L.layerGroup().addTo(map); // doesn't show the image

  let prov = {};

  var OpenStreetMap_Mapnik = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
  }).addTo(map);

  prov['OpenStreetMap_Mapnik'] = OpenStreetMap_Mapnik;

  var Esri_WorldImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
  });

  prov['Esri_WorldImagery'] = Esri_WorldImagery;

  var CartoDB_Voyager = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
    subdomains: 'abcd',
    maxZoom: 20
  });

  prov['CartoDB_Voyager'] = CartoDB_Voyager;

  L.control.mousePosition().addTo(map);

  function project(loc) {
      let [x, y] = loc;

      // coordinates of the plane corners in NW, NE, SW, SE order.(in a "Z" shape)
      let [[x0, y0], [x1, y1], [x2, y2], [x3, y3]] = img.getCorners().map(corner => [corner.lng, corner.lat]);

      // Normalize input point coordinates from [-131072, 131072] to [0, 1]
      let nx = (x + 131072) / 262144;
      let ny = 1 - (y + 131072) / 262144; 

      // this is affine transformation, not the css matrix3d
      const interpolate = (a, b, c, d, nx, ny) => {
          return (1 - nx) * (1 - ny) * a + 
                nx * (1 - ny) * b + 
                (1 - nx) * ny * c + 
                nx * ny * d;
      };

      let projX = interpolate(x0, x1, x2, x3, nx, ny);
      let projY = interpolate(y0, y1, y2, y3, nx, ny);

      return [projY, projX];
  }

  function loadMarkers() {
    fetch(markersURL).then(r=>r.json()).then(data=>{
      let settings = {area:'LondonWorld'};
      markers = L.geoJSON(data, {
        style: f => {color: f.properties.color},
        filter: f=> {
          return f.properties.location == settings.area && (!settings.filter || f.properties.description==settings.filter);
        },
        pointToLayer: function (feature, latlng) {
          return L.marker(latlng, {draggable: false, opacity: 1, feature: feature});
        }
      })
      .bindPopup(l => { return '<pre>'+JSON.stringify(l.feature, null, 2)+'</pre>' + String(l._latlng); })
      .bindTooltip(l => l.feature.properties.title)
      .addTo(map);

      postLoading();
    })
  }

  function postLoading() {

    img = L.distortableImageOverlay(imageURL, {
      mode: 'lock',
      selected: true,
      //actions: [L.DragAction, L.ScaleAction, L.DistortAction, L.RotateAction, L.FreeRotateAction, L.LockAction, L.OpacityAction, L.BorderAction, L.ExportAction, L.DeleteAction, L.RestoreAction],
      actions: [L.ScaleAction, L.RotateAction, L.OpacityAction, L.RestoreAction, L.LockAction],
      corners: settings.corners,
    }).on('update', imageUpdated).on('load', updateMarkers)

    imgGroup.addLayer(img);

    var layerControl = L.control.layers(prov, { 'Markers': markers, 'Images': imgGroup }).addTo(map);
  }

  function updateMarkers() {
    for (marker of Object.values(markers._layers)) {
      marker.setLatLng( project( marker.options.feature.geometry.coordinates ) );
    }
  }

  function imageUpdated(e) {
    settings.corners = e.target.getCorners();
    updateMarkers();
    saveSettings();
  }

  function saveSettings() {
    localStorage.setItem(localDataName, JSON.stringify(localData));
  }

  loadMarkers();

</script>
</body>
</html>
