<!DOCTYPE html>
<html lang="en">
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">  

  <title>Leaflet - Remap</title>
  <link rel="shortcut icon" type="image/x-icon" href="data:," />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.toolbar.js/0.1.0/Leaflet.Toolbar.min.css" integrity="sha512-GA6tz0ONkXAXGUnZU9M7mMkiOiXuXis56gRc73qvS+hXP0Sgb/mXihcqs6haKhes6mMeCPIdopIDixMwnnd+Iw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.toolbar.js/0.1.0/Leaflet.Toolbar.min.js" integrity="sha512-5jHQLJ93JywT7NbjOuyHQzqLsTNYc7mjj0U5bBmsnrE1P9+4qqjKak0H+8jSlTzeNcbtDiTbV68pMQNTXbSTHQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-distortableimage@0.21.9/dist/leaflet.distortableimage.min.css">
  <script src="https://cdn.jsdelivr.net/npm/leaflet-distortableimage@0.21.9/dist/vendor.min.js"></script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-distortableimage@0.21.9/dist/leaflet.distortableimage.min.css">
  <script src="https://cdn.jsdelivr.net/npm/leaflet-distortableimage@0.21.9/dist/vendor.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet-distortableimage@0.21.9/dist/leaflet.distortableimage.min.js"></script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-mouse-position@1.2.0/src/L.Control.MousePosition.min.css">
  <script src="https://cdn.jsdelivr.net/npm/leaflet-mouse-position@1.2.0/src/L.Control.MousePosition.min.js"></script>

  <!--
  -->

  <!--
  <link rel="stylesheet" href="leaflet.css" />
  <script src="leaflet.js"></script>
  <link rel="stylesheet" href="leaflet.toolbar.min.css"/>
  <script src="leaflet.toolbar.min.js"></script>
  <link rel="stylesheet" href="leaflet.distortableimage.css"/>
  <script src="vendor.js"></script>
  <script src="leaflet.distortableimage.js"></script>
  <script src="L.Control.MousePosition.js"></script>
  -->


  <style>
    html, body {
      height: 100%;
      width: 100%;
      margin: 0;
    }
    #map {
      height: 100%;
      width:  100%;
    }
  </style>
</head>
<body>

<div id="map" ></div>
<script>

  let localDataName = 'joricsRemap';
  let localData = JSON.parse(localStorage.getItem(localDataName)) || {};
  function saveSettings() {
    //console.log(settings);
    localStorage.setItem(localDataName, JSON.stringify(localData));
  }

  let markers;


  let settings = localData;
  let london = [51.505, -0.09];

  //console.log(L.Toolbar2);

  let pos = london;
  //let pos = [0,0];
  //let zoom = 0;
  let zoom = 12;

  let imageOpacity = .7;
  let imageOverlay = null;

  let imageURL = '../data/LondonWorld.jpg';

  let w = h = 262144;

  let handles = [];

  const map = L.map('map', {
    //crs: L.extend({}, L.CRS.Simple, {}),
    //zoomDelta: .01,
    //zoomSnap: .01,

    zoomSnap: .1,
    wheelDebounceTime: 100,

  }).setView(pos, zoom);

  let prov = {};


var OpenStreetMap_Mapnik = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);

  prov['OpenStreetMap_Mapnik'] = OpenStreetMap_Mapnik;

var OpenTopoMap = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
  maxZoom: 17,
  attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)'
});

  //prov['OpenTopoMap'] = OpenTopoMap;


var Esri_WorldImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
  attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
});

  prov['Esri_WorldImagery'] = Esri_WorldImagery;


var GeoportailFrance_orthos = L.tileLayer('https://data.geopf.fr/wmts?REQUEST=GetTile&SERVICE=WMTS&VERSION=1.0.0&STYLE={style}&TILEMATRIXSET=PM&FORMAT={format}&LAYER=ORTHOIMAGERY.ORTHOPHOTOS&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}', {
  attribution: '<a target="_blank" href="https://www.geoportail.gouv.fr/">Geoportail France</a>',
  bounds: [[-75, -180], [81, 180]],
  minZoom: 2,
  maxZoom: 19,
  format: 'image/jpeg',
  style: 'normal'
});

  //prov['GeoportailFrance_orthos'] = GeoportailFrance_orthos;



var USGS_USImagery = L.tileLayer('https://basemap.nationalmap.gov/arcgis/rest/services/USGSImageryOnly/MapServer/tile/{z}/{y}/{x}', {
  maxZoom: 20,
  attribution: 'Tiles courtesy of the <a href="https://usgs.gov/">U.S. Geological Survey</a>'
});
  

//  prov['USGS_USImagery'] = USGS_USImagery;


var CartoDB_Voyager = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
  subdomains: 'abcd',
  maxZoom: 20
});

prov['CartoDB_Voyager'] = CartoDB_Voyager;


  L.control.mousePosition().addTo(map);

  let images = new L.layerGroup().addTo(map);

  let img = L.distortableImageOverlay(imageURL, {
    mode: 'lock',
    //selected: true,
    //actions: [L.DragAction, L.ScaleAction, L.DistortAction, L.RotateAction, L.FreeRotateAction, L.LockAction, L.OpacityAction, L.BorderAction, L.ExportAction, L.DeleteAction, L.RestoreAction],
    //actions: [L.ScaleAction, L.RotateAction, L.OpacityAction, L.RestoreAction, L.LockAction],
    actions: [L.ScaleAction, L.OpacityAction, L.RestoreAction, L.LockAction],
  }).on('update', imageUpdated)
    .on('load', e=>{ setTimeout(function(){ imageLoaded(img) }, 0) })
    .addTo(map)

  let scale = 1/2000000;

  function project(latlng) {

    let center = img.getCenter();
    let angle = img.getAngle();
    let corners = img.getCorners();

    // markers should match image bounds

    // Returns the coordinates of the image corners in NW, NE, SW, SE order.

    let [[x0,y0], [x1,y1], [x2,y2]] = [
      [corners[0].lng, corners[0].lat],
      [corners[1].lng, corners[1].lat],
      [corners[2].lng, corners[2].lat]
    ]

    let sw = Math.sqrt( Math.pow(x1-x0,2) + Math.pow(y1-y0,2)  );
    let sh = Math.sqrt( Math.pow(x2-x0,2) + Math.pow(y2-y0,2)  );

    //console.log(sw, sh);

    let scalew = sw / w;
    let scaleh = sh / h;

    //console.log(center, angle);

    latlng = L.latLng(latlng);
    let [x, y] = [latlng.lng, latlng.lat];

    let r = -angle * (Math.PI / 180);


    let tx = x * Math.cos(r) - y * Math.sin(r);
    let ty = x * Math.sin(r) + y * Math.cos(r);
    x = tx;
    y = ty;

    x *= scalew;
    y *= scaleh;

    x += center.lng;
    y += center.lat;


    return [y,x];
  }

  function loadMarkers() {
    fetch('../data/geojson.markers.folon.json').then(r=>r.json()).then(data=>{
      let settings = {area:'LondonWorld'};
      markers = L.geoJSON(data, {
        style: f => {color: f.properties.color},
        filter: f=> {
          return f.properties.location == settings.area && (!settings.filter || f.properties.description==settings.filter);
        },
        pointToLayer: function (feature, latlng) {
          return L.marker(project(latlng), {draggable: true, opacity: 1});
        }
      })
      .bindPopup(l => { console.log(l); return '<pre>'+JSON.stringify(l.feature, null, 2)+'</pre>' + String(l._latlng); })
      .bindTooltip(l => l.feature.properties.title)
      .addTo(map);

      postLoading();

    })
  }

  function postLoading() {
    var baseMaps = {
    };
    var overlayMaps = {
        "Markers": markers,
        "Images": img,
    };
    var layerControl = L.control.layers(prov, overlayMaps).addTo(map);
  }

  function imageUpdated(e) {
    let img = e.target;
    settings.corners = img.getCorners();
    saveSettings();
  }

  function imageLoaded(img) {
    if (settings.corners) {
      //console.log('settings corners to', settings.corners);
      img.setCorners( settings.corners )
    }
    img.select();
    loadMarkers();
  }

</script>



</body>
</html>



